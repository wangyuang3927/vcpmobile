# VCPMobile v1.2.0 更新日志

**发布日期**: 2026-02-17

## 一、功能变更

### 新增功能
- **思维链展示（Reasoning Chain）**: 支持展示 AI 模型的思考过程。当模型返回 `reasoning_content`（如 DeepSeek 等支持思维链的模型）时，AI 回复气泡顶部会出现可折叠的「💭 思考过程」区域。流式输出时自动展开显示"思考中..."，回复完成后自动折叠，用户可点击展开查看完整思考链。

### 优化改进
- **沙箱挂载性能优化**: 历史消息的富文本沙箱（iframe）挂载改为分批处理，每 3 个沙箱让出一次事件循环，避免切换话题时 UI 卡顿。
- **消息去重增强**: 从服务端同步消息时增加前缀匹配去重（role + content前80字符 + timestamp），防止网络抖动导致的重复消息。
- **上游代码同步**: 合并 VCPToolBox 和 VCPChat 原作者最新更新。

### 上游更新内容
- **VCPToolBox**: 思维链 API 参数适配（`thinking: {type: "enabled"}`）、RAG 日记去重优化、日记搜索队列重构修复死锁
- **VCPChat**: 统一使用 agentConfigManager 管理 Agent 配置，去除直接文件读写

## 二、技术实现

### 架构变更
- `vcpApi.js` 的 `streamChat` 新增 `onReasoning` 回调参数，与 `onChunk` 并行处理流式数据
- 消息对象新增 `reasoning` 字段存储思维链内容
- `mountSandboxesForHistory` 从同步 forEach 改为异步分批循环

### 代码变更
- `src/services/vcpApi.js` — 新增 `onReasoning` 回调，将 `reasoning_content` 传递给调用方
- `src/App.vue` — assistantMessage 增加 `reasoning` 字段；两处 `streamChat` 调用增加 `onReasoning`；模板增加可折叠思维链区域；`mountSandboxesForHistory` 分批处理；`switchTopic` 消息合并增加去重逻辑
- `src/style.css` — 新增 `.reasoning-block`、`.reasoning-summary`、`.reasoning-content` 等思维链样式，支持暗色/亮色主题

## 三、依赖项目变更

### VCPToolBox 需要的改动
- `routes/vcpchatMobileRoutes.js` — simplifyContent 保留 `<img>` 标签（v1.1.1 已有的改动）
- 本次合并了上游 5 个提交，无额外改动需要

### VCPChat 需要的改动
- 本次合并了上游 1 个提交（统一 agentConfigManager），冲突已解决，无额外改动需要

### 无需额外改动
- 上游更新均为服务端/桌面端内部优化，API 接口未变，VCPMobile 无需适配即可受益
